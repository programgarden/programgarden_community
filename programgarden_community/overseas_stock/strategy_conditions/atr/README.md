# 해외주식 ATR 변동성 분석 전략 (Average True Range)

## 전략 ID
`ATR`

## 전략 기여자
ProgramGarden Team

## 간단한 설명

이 전략은 **"지금 이 종목이 얼마나 크게 움직이는지"를 숫자로 알려주는 도구**입니다.

ATR은 "평균 진정 범위"라고 번역되는데, 쉽게 말해 **"하루에 이 종목이 보통 얼마나 움직이나"**를 알려줍니다. 이 값으로 **손절 가격, 목표가, 포지션 크기**를 정하는 데 활용합니다.

## 📊 ATR 시각화

### 1. ATR 기반 손절 설정

ATR을 활용하여 변동성에 맞는 손절가를 설정합니다.

![ATR 손절 설정](./images/atr_stop_loss.png)

### 2. 변동성 레벨 게이지

NATR(정규화 ATR)로 변동성 수준을 파악합니다.

![ATR 변동성 게이지](./images/atr_volatility_gauge.png)

## 이 전략이 필요한 이유

- "손절을 몇 % 아래에 잡아야 하나?" → ATR로 결정할 수 있습니다.
- "이 종목은 얼마나 위험한가?" → ATR이 크면 변동성이 크고 위험합니다.
- "같은 리스크로 몇 주를 사야 하나?" → ATR로 포지션 크기를 계산합니다.
- 유명한 **터틀 트레이딩** 전략도 ATR을 기반으로 합니다!

## 전략 상세 설명

### 먼저, 용어를 간단히 정리해 볼게요

- **True Range (진정 범위, TR)**
    - 하루 동안 가격이 **실제로 움직인 범위**입니다.
    - 단순히 "고가 - 저가"가 아니라, **갭(전일 종가와 당일 가격 차이)**도 포함합니다.
    - 세 값 중 가장 큰 값을 사용합니다:
        1. 당일 고가 - 당일 저가
        2. |당일 고가 - 전일 종가|
        3. |당일 저가 - 전일 종가|

- **ATR (Average True Range)**
    - 최근 N일간 True Range의 평균입니다.
    - **"이 종목이 하루에 보통 얼마나 움직이는가"**를 나타냅니다.
    - 예: ATR = $3이면 "하루에 보통 $3 정도 움직인다"

- **NATR (Normalized ATR, 정규화된 ATR)**
    - ATR을 현재가로 나눈 뒤 100을 곱한 값입니다 (퍼센트).
    - **"가격 대비 몇 % 움직이는가"**를 나타냅니다.
    - 예: NATR = 2%면 "가격의 2% 정도 매일 움직인다"

- **변동성 (Volatility)**
    - 가격이 얼마나 크게 흔들리는지를 말합니다.
    - ATR/NATR이 크면 변동성이 높고, 작으면 변동성이 낮습니다.

### NATR이 왜 필요한가요?

**같은 $2 움직임도 종목마다 의미가 다릅니다!**

| 종목 | 주가 | ATR | NATR | 의미 |
| --- | --- | --- | --- | --- |
| A | $100 | $2 | 2% | 안정적 |
| B | $10 | $2 | 20% | 매우 변동적! |

→ 같은 ATR $2여도, $10짜리 종목에서는 엄청난 변동성입니다.
→ **NATR로 비교해야 정확합니다**.

### 어떤 방식으로 동작하나요?

1. **데이터 수집**
    - LS증권 OpenAPI 차트 데이터를 이용해 가격 정보를 가져옵니다.

2. **True Range 계산**
    - 각 캔들의 진정 범위를 계산합니다.

3. **ATR 계산**
    - True Range의 지수이동평균(Wilder's Smoothing)을 구합니다.

4. **NATR 계산**
    - (ATR / 종가) × 100으로 정규화합니다.

5. **변동성 수준 판단**
    - NATR이 높으면 **고변동성**, 낮으면 **저변동성**으로 분류합니다.

### ATR 활용법 (핵심!)

#### 1. 손절 라인 설정 (Trailing Stop)
```
롱 포지션: 손절가 = 진입가 - (ATR × 배수)
숏 포지션: 손절가 = 진입가 + (ATR × 배수)

예시: $150에 매수, ATR = $3, 배수 = 2
손절가 = $150 - ($3 × 2) = $144
```
→ 변동성에 맞춰 손절선을 설정하니까, **평소 움직임에 털리지 않으면서도 진짜 하락에는 대응**할 수 있습니다.

#### 2. 포지션 크기 결정 (터틀 방식)
```
1 Unit = (총 자산 × 리스크 %) / ATR

예시: 계좌 $50,000, 리스크 1%, ATR = $2
1 Unit = ($50,000 × 0.01) / $2 = 250주
```
→ 변동성이 큰 종목은 적게 사고, 작은 종목은 많이 사서 **리스크를 동일하게** 맞춥니다.

#### 3. 변동성 돌파 전략
```
매수 조건: 당일 시가 + (전일 ATR × K) 돌파
매도 조건: 당일 시가 - (전일 ATR × K) 이탈
```
→ ATR을 기준으로 "오늘 얼마나 움직여야 추세로 볼 것인가"를 정합니다.

### 활용 시나리오

- 손절선을 **"몇 % 아래"**가 아니라 **"변동성 기반"**으로 잡고 싶을 때
- 여러 종목의 **변동성을 비교**해서 위험한 종목/안정적인 종목을 구분하고 싶을 때
- 터틀 트레이딩처럼 **변동성 기반 포지션 사이징**을 하고 싶을 때
- 변동성이 낮아진 종목에서 **곧 큰 움직임이 나올 것**을 예측하고 싶을 때 (스퀴즈)

## DSL 예시

```python
{
    "condition_id": "ATR",
    "params": {
        "appkey": "발급받은 LS증권 키",
        "appsecretkey": "발급받은 LS증권 시크릿",
        "period": 14,
        "atr_multiplier": 2.0,
        "high_volatility_threshold": 2.0,
        "low_volatility_threshold": 0.5,
        "timeframe": "days",
        "qrycnt": 200
    }
}
```

## 파라미터 설명

| 이름 | 타입 | 기본값 | 설명 |
| --- | --- | --- | --- |
| `appkey` | str | - | LS증권에서 발급받은 Open API 키입니다. |
| `appsecretkey` | str | - | LS증권에서 발급받은 Open API 시크릿입니다. |
| `period` | int | 14 | ATR 계산 기간입니다. 14일이 표준입니다. |
| `atr_multiplier` | float | 2.0 | 손절선 계산 시 ATR에 곱할 배수입니다. |
| `high_volatility_threshold` | float | 2.0 | NATR이 이 값 이상이면 "고변동성"으로 판단합니다 (%). |
| `low_volatility_threshold` | float | 0.5 | NATR이 이 값 이하면 "저변동성"으로 판단합니다 (%). |
| `timeframe` | str | "days" | 캔들 주기입니다. `"days"`, `"weeks"`, `"months"` 중 선택 |
| `qrycnt` | int | 200 | 불러올 캔들 개수입니다. |

## 응답 데이터 설명

| 필드 | 설명 |
| --- | --- |
| `volatility_level` | 변동성 수준입니다. `"high"`, `"normal"`, `"low"` |
| `atr` | 현재 ATR 값 (금액)입니다. |
| `natr` | 현재 NATR 값 (%)입니다. |
| `current_price` | 현재 종가입니다. |
| `stop_loss_long` | 롱 포지션 손절가 추천입니다 (현재가 - ATR × 배수). |
| `stop_loss_short` | 숏 포지션 손절가 추천입니다 (현재가 + ATR × 배수). |
| `atr_expanding` | ATR이 확대 중인지 여부입니다. 확대 중이면 변동성 증가. |
| `atr_contracting` | ATR이 축소 중인지 여부입니다. 축소 중이면 돌파 대기 가능. |

## 신호 해석 가이드

| 변동성 수준 | NATR 범위 | 의미 | 대응 |
| --- | --- | --- | --- |
| `high` | 2% 이상 | 변동성이 높음 | 손절폭 넓게, 포지션 작게 |
| `normal` | 0.5% ~ 2% | 일반적인 변동성 | 표준적인 손절/포지션 |
| `low` | 0.5% 이하 | 변동성이 낮음 | 횡보장, 돌파 전략 고려 |

## ATR 활용 실전 예시

### 예시 1: 손절선 설정
- AAPL 주가: $180, ATR: $4, 배수: 2
- 손절가 = $180 - ($4 × 2) = **$172**
- "평소에 $4 정도 움직이니까, $8 이상 빠지면 진짜 하락"

### 예시 2: 포지션 사이징
- 계좌: $100,000, 리스크: 1%
- AAPL ATR: $4 → 250주 ($100,000 × 0.01 / $4)
- TSLA ATR: $20 → 50주 ($100,000 × 0.01 / $20)
- → 변동성 큰 TSLA는 적게, AAPL은 많이 사서 리스크 동일화!

### 예시 3: 변동성 비교
- AAPL NATR: 2.2% → 평균적인 변동성
- TSLA NATR: 4.5% → 높은 변동성
- → TSLA가 더 위험하고, 더 큰 수익 또는 손실 가능

## 전략 사용 시 주의사항

- ATR은 **방향을 알려주지 않습니다**. 오직 "얼마나 움직이는가"만 알려줍니다.
- 실적 발표, 중요 이벤트 전후에는 ATR이 급등할 수 있습니다.
- `period`를 너무 짧게 설정하면 최근 변동에 과민 반응합니다.
- **ATR이 낮다고 안전한 게 아닙니다**. 낮은 ATR 후에 큰 움직임이 올 수 있습니다 (압축 후 폭발).
- 다른 지표와 함께 사용하면 더 효과적입니다. 특히 **ADX와 함께** 사용하면 추세 강도와 변동성을 동시에 파악할 수 있습니다.
